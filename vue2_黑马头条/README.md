# Vue2*web*移动端黑马头条

## Project setup

```
npm install
```

### Compiles and hot-reloads for development

```
npm run serve
```

### Compiles and minifies for production

```
npm run build
```

### Lints and fixes files

```
npm run lint
```

### Customize configuration

See [Configuration Reference](https://cli.vuejs.org/config/).

技术： vue2 核心 vue、vue-router 路由插件、axios 请求插件、json-bigint 最大安全数值处理、vant 移动组件库(有赞)、amfe-flexible rem 适配

开发依赖：babel ES 转换器、less css 预处理器、postcss css 后处理器、vue-cli vue 项目脚手架、git 管理、ESLint 规范（Standard 提供校验规则）

## 一. 准备阶段

### 一. 屏幕适配配置 (Rem 适配)

1. 安装依赖包 **postcss-pxtorem（ 负责把 px 单位转换为 rem 单位）** **lib-flexable**（用于设置 rem 基准值）

2. 配置 postcss.config.js

   rootValue 表示以该值作为 rem 的基准值（vant 最佳显示状态）(现在流行 37.5）

   propList 那些 css 属性的像素值转换为 rem 单位（所有属性都要转换，则为 \* ）

3. 导入 **import 'amfe-flexible'** （用于动态计算当前页面的 HTML 的 font-size 基准值并且动态设置）

### 二. 路由配置

1. 一级路由：login 登录组件、home 布局组件；二级路由：**/main** /question /video **/my**

### 三. 完成基本 layout 组件配置

根据底部菜单栏标签跳转到对应的二级路由组件页面

### 四. 封装通用的接口模块 (采用 axios)

1. 请求拦截器（判断是否有 token（使用 sessionStorage.getItem 看是否获取到 token），有就统一添加到请求头）
2. 响应拦截器（处理返回的数据，比如少写一层 data 等等）

## 二. 登录模块

1. ### 采用技术：

   - vant-form 组件
   - vuex 管理登录用户信息、
   - vue-router
   - 导航守卫
   - axios
   - LocaStorage

2. ### 实现基本流程

   - #### 实现基本布局

     - 使用 vant-form 组件，和插槽

   - #### 实现基本登录功能

     - 封装登录接口
     - 双向绑定表单数据，进行表单验证（手动验证或者使用 vant 提供的规则），使用 try（）catch（）结构调用接口，验证登录
     - 验证成功，跳转（验证期间添加加载状态提示进度条，提升用户体验）
     - 设置路由导航守卫，通过导航守卫控制登录权限，如果用户没有登录，主页不让看到（通过缓存的 token 的存在性）
     - 拦截所有的路由请求 通过 router.beforeEach((to, from, next) => {} 判断用户是否已经登录，登录状态可以跳转，没有登录跳到登录页面

3. ### 遇到的问题

   - #### token 续签问题

     - `token` 用于访问需要身份认证的普通接口，有效期 2 小时
     - `refresh_token` 用于在 token 过期后，获取新的用户 token，有效期 14 天
     - 在响应拦截器中，在失败的情况下，根据`refresh_token`使用 axios 申请一个新的 token，用新的 token 更新本地缓存的 token
     - 重新发送请求调用刚才出错的地址，申请新的 token 也失败，则跳转到登录页

   - #### 插槽的用法（补充）

     - 插槽本质上，依然是父组件向子组件传递信息
     - 简单的说就是：slot 标签中间的内容表示默认值：父组件如果没有传递插槽内容，显示默认值
     - 给 slot 添加 name 属性，在父组件中通过 name 属性值给对应的 slot 添加内容

## 三. 主页模块

1. ### 采用技术

   - 布局技术：van-tabs，van-list 上拉加载，van-pull-refresh 下拉刷新以及 vant 弹出框组件
   - 时间戳分页技术
   - 自定义过滤器，自定义插件
   - 图片懒加载

2. ### 实现流程

   - **头部频道基本布局**（van-tabs 与 van-cell 结合）
   - **实现文章列表基本布局**(van-list 与 van-cell 结合)
   - 实现**上拉加载**，**下拉刷新**
     - 通过控制组件是否再刷新状态（是否再调接口的过程中）来控制刷新的显示
   - 调用接口获取**我的频道数据**，并动态**渲染**
   - 点击编辑频道按钮可进行**频道编辑**：

     - 实现编辑频道弹窗布局
     - 调用接口，处理我的频道数据和计算可选频道数据
     - 动态添加删除我的频道：分别在 data 中定义我的频道数组和可选频道数组，操作这两组数据，实现动态增删

   - 根据当前频道的 id**获取**对应的**文章列表**，并**渲染**到页面
     - 点击不同的频道，获取点击**频道的 id**，根据这个 id 来调接口**获取对应的文章列表**，更新 data 中的文章列表数据，并**渲染**到页面
     - 获取的文章列表基于**时间戳分页**（根据当前时间，第一页数据是空，所以要根据第一次返回的时间戳再次发送请求才可以获取文章列表数据）
   - 根据当前文章 id，将文章添加到不喜欢，或者进行举报
     - 点击文章右下角的叉号，获取当前点击的文章的 id，弹出对话框，用户选择不喜欢的原因，调用接口，传入 id 和原因，并在页面中删除当前的文章

3. ### 问题总结

   - **函数节流**：
     - 上一次数据没有加载成功，下一个加载可能会触发（数据加载不准确）
     - 在固定的时间内（1 秒），无论触发多少次条件（onLoad 触发一次），仅仅执行一次任务（加载一页数据）
     - 例：在全局定义一个变量 N，赋值为 false，在定时器中 先进行判断 N，为真则跳出定时器，为假继续执行下面代码，代码中第一行就先给 N 赋值为 true，定时器代码最后一句，给 N 赋值为 false，这样保证了，这个定时器执行的过程中，在次触发这个定时器，就不会重复执行。
   - **全局过滤器**更换设时间格式
     - 使用 dayjs 包，在 vue 的 install 方法中定义一个全局时间过滤器
     - 在 install 方法中，可以使用 Vue.prototype 定义原型链，vue.component 定于组件，vue.filter 定义过滤器
   - **图片懒加载**
     - 在 img 标签上添加 v-lazy 指令即可
     - 在 vant 中 需 `import Vant, { Lazyload } from 'vant'` 然后 `Vue.use(Lazyload)` 然后在 vant 的图片标签中：`<van-image lazy-load></van-image>`
   - 解决防盗链：在 index.html 中添加 `<meta name="referrer" content="never">`
   - 文章 id 超范围问题：使用**json-bigint**包，原理是用数组存储，使用的时候把数组转化为字符串

## 四. 搜索模块

1. #### 采用技术

   - van-search 搜索组件
   - 编程式路由导航
   - localStorage 获取历史记录
   - 数组去重，基于 ES6 提供 Set 构造函数进行去重
   - 函数节流（防抖）

2. #### 实现流程

   - 搜索组件**基本布局**（使用 van-search 搜索组件）
     - 搜索框，搜索历史，联想列表
   - 实现**历史记录**
     - 初始化历史数据，在 localStorage 中获取历史关键字，如果存在，就渲染道页面，不存在就隐藏历史记录模块
     - 历史记录的数字去重，基于 ES6 提供 Set 构造函数进行去重：`new Set(this.history)`
   - 实现**联想搜索功能**
     - 封装搜索接口方法
     - 当用户输入内容后，调用接口，将输入的内容传值，获取联想数据
     - 函数防抖 debounce ：连续两次触发条件超过特定时间才会执行一次任务。（关键字搜索、账号重复性验证）
     - 函数节流 throttle：在固定的时间内，无论触发多少次条件，仅仅执行一次任务。（分页动态加载）
   - 实现**搜索页面的跳转**
     - 封装搜索接口
     - 搜索框内容作为参数，调用搜索接口
     - 联想内容作为参数，调用搜索接口，先将联想文字的高亮标签去掉，然后作为参数传递
     - 将传递的参数存入缓存中的搜索历史中
   - 搜索结果页面布局
     - 基于 pagesize 和 page 分页

3. #### 问题总结

   - 实现联想列表的**高亮控制**：让列表项内容与关键字匹配后高亮（包裹一层 span 标签）
     - 使用 map 方法操作联想数据的内容，用正则表达式构造函数 new RegExp(）匹配获取的每一条联想的跟输入内容一样的关键字，再使用 replace(）方法，把关键字外面加入一层 span 标签

## 五. 文章详情

1. #### 采用技术

   - 编程式导航

2. #### 实现流程

   - 配置路由
   - 封装接口，根据当前点击文章列表的 id 获取文章详情，并渲染页面
   - 文章作者的关注与取消关注
     - 绑定事件
     - 封装关注与取消关注接口，根据是否关注，渲染出关注按钮或者取消关注按钮
   - 文章点赞与不喜欢
     - 绑定事件
     - 封装点赞与不喜欢接口，二者不能同时选中，单可以都不选中，使用 if-else 先宏观再微观（先做大的分支处理，再做细节）
   - 文章评论模块
     - 将评论模块单独拆分
     - 评论组件布局，调用接口将评论列表渲染
     - 文章评论功能：封装接口，绑定提交时间，将输入框的内容作为参数传递

3. #### 问题总结

   无
